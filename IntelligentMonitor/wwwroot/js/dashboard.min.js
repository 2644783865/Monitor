layui.use(["form","layer"],function(){function c(n,t){for(var r=[],i=0;i<n.length;i++)i!=t&&r.push(n[i]);return r}function l(n,t){setTimeout(function(){for(var i,u,t=0;t<n.length;t++)i=e[n[t]],u="/api/Zabbix/history?itemids="+n[t]+"&history="+i,r(u,t)},100);var i=[],r=function(n,r){var u=[];$.ajax({type:"get",url:n,dataType:"json",success:function(n){var o=n.result,f=[],e;o.map(function(n){f.push(n.value);u.push(y(n.clock))});e={name:t[r],type:"line",data:f};i.push(e);a(i,u,t)}})}}function a(n,t,i){f.clear();var r={tooltip:{trigger:"axis"},legend:{data:i},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",data:t},yAxis:{type:"log"},series:n};f.setOption(r);f.hideLoading()}function y(n){var s=new Date,o=new Date(n*1e3),u=o.getMonth()+1,t,i,r,f,e;return(u=u<10?"0"+u:u,t=o.getDate(),t=t<10?"0"+t:t,i=o.getHours(),i=i<10?"0"+i:i,r=o.getMinutes(),r=r<10?"0"+r:r,f=s.getMonth()+1,f=f<10?"0"+f:f,e=s.getDate(),e=e<10?""+e:e,u==f&&t==e)?i+":"+r:u+"/"+t+" "+i+":"+r}var i=layui.form,r=layui.layer,o,u,e;$(".layui-form-item .layui-form-label").css("width","auto");o="";u="";let t=[],n=[],s={};e={};let h="shine",f=echarts.init(document.getElementById("charts")),v=$(".query>div").prop("outerHTML");a([],[],[]);$.getJSON("/js/themes/"+h+".json",function(n){echarts.registerTheme(h,n.theme);s=n.loading});$.getJSON("/api/Zabbix/hostgroup",function(n){for(var r='<option value=""><\/option>',t=0;t<n.result.length;t++)r+='<option value="'+n.result[t].groupid+'">'+n.result[t].name+"<\/option>";$(".group").html(r);i.render("select")});$(".query").delegate(".btnQuery","click",function(){$(".query").append(v);var n=$(this.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.lastChild).find(".group");$.getJSON("/api/Zabbix/hostgroup",function(t){for(var u='<option value=""><\/option>',r=0;r<t.result.length;r++)u+='<option value="'+t.result[r].groupid+'">'+t.result[r].name+"<\/option>";n.html(u);i.render("select")});$(this).parent().parent().find("div:eq(0)").removeClass("layui-hide");$(this).parent().parent().find("div:gt(0)").remove()});$(".query").delegate(".btnRemoveQuery","click",function(){var i=$(".btnRemoveQuery").index(this);$(this.parentNode.parentNode.parentNode.parentNode.parentNode).remove();t=c(t,i);n=c(n,i);l(n,t)});i.on("select",function(r){var h=$(r.elem),c=h.parent().parent().parent().parent().parent(),p=h.hasClass("group"),w=h.hasClass("host"),b=h.hasClass("application"),k=h.hasClass("item"),a,y,v;p&&$.getJSON("/api/Zabbix/host?groupids="+r.value,function(n){for(var r='<option value=""><\/option>',t=0;t<n.result.length;t++)r+='<option value="'+n.result[t].hostid+'">'+n.result[t].name+"<\/option>";c.find(".host").html(r);i.render("select")});w&&(o=$(this).text(),$.getJSON("/api/Zabbix/application?hostids="+r.value,function(n){for(var r='<option value=""><\/option>',t=0;t<n.result.length;t++)r+='<option value="'+n.result[t].applicationid+'">'+n.result[t].name+"<\/option>";c.find(".application").html(r);i.render("select")}));b&&$.getJSON("/api/Zabbix/item?applicationids="+r.value,function(n){for(var r,s,f,u,o='<option value=""><\/option>',t=0;t<n.result.length;t++){if(r=n.result[t].name,e[n.result[t].itemid]=n.result[t].value_type,r.indexOf("$")>=0)for(s=n.result[t].key_,f=s.match(/\[(.+?)\]/g)[0].replace("[","").replace("]","").split(","),u=0;u<f.length;u++)r=r.replace("$"+(u+1),f[u]);o+='<option value="'+n.result[t].itemid+'">'+r+"<\/option>"}c.find(".item").html(o);i.render("select")});k&&(u=o+"_"+$(this).text(),a=c.find(".itemId").val(),y=function(n){return n==a},a>0?(v=n.findIndex(y),n[v]=r.value,t[v]=u):(n.push(r.value),t.push(u)),u="",c.find(".itemId").val(r.value),f.showLoading(s),l(n,t))});i.on("submit(save)",function(){return t.length>0&&n.length>0?r.prompt({title:"请输入此图表名称",formType:0},function(i,u){var o,h;r.close(u);var f={},s=[];for(o=0;o<n.length;o++)h=e[n[o]],s.push(h);f.itemId=n.join(",");f.timeFrom="";f.timeTill="";f.itemName=t.join(",");f.historys=s.join(",");f.chartsName=i;$.ajax({type:"post",url:"/api/Charts/add_charts",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(f),success:function(n){n.code==0?r.msg(n.msg,{icon:1,time:1e3},function(){window.location.reload()}):r.msg(n.msg,{icon:5,time:1e3})}})}):r.msg("无监控数据，不可保存"),!1});window.addEventListener("resize",function(){f.resize()})});