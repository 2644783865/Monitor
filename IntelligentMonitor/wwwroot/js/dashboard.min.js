layui.use(["form","layer"],function(){function s(n,t){for(var r=[],i=0;i<n.length;i++)i!=t&&r.push(n[i]);return r}function h(n,t){for(var r="/api/Zabbix/history?",i=0;i<n.length;i++)r+="&itemids="+n[i];$.getJSON(r,function(i){for(var u,f,o,e=[],s=i.result,r=0;r<n.length;r++)u=[],f=[],s.map(function(t){t.itemid==n[r]&&(f.push(t.value),u.push(a(t.clock)))}),o={name:t[r],type:"line",data:f},e.push(o);c(e,u,t)})}function c(n,t,i){f.clear();let r={tooltip:{trigger:"axis"},legend:{data:i},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",boundaryGap:!1,data:t},yAxis:{type:"value"},series:n};f.setOption(r);f.hideLoading()}function a(n){var s=new Date,o=new Date(n*1e3),u=o.getMonth()+1,t,i,r,f,e;return(u=u<10?"0"+u:u,t=o.getDate(),t=t<10?"0"+t:t,i=o.getHours(),i=i<10?"0"+i:i,r=o.getMinutes(),r=r<10?"0"+r:r,f=s.getMonth()+1,f=f<10?"0"+f:f,e=s.getDate(),e=e<10?""+e:e,u==f&&t==e)?i+":"+r:u+"/"+t+" "+i+":"+r}var n=layui.form,r=layui.layer,u;$(".layui-form-item .layui-form-label").css("width","auto");u="";let t=[],i=[],e={},o="shine",f=echarts.init(document.getElementById("charts")),l=$(".query>div").prop("outerHTML");c([],[],[]);$.getJSON("/js/themes/"+o+".json",function(n){echarts.registerTheme(o,n.theme);e=n.loading});$.getJSON("/api/Zabbix/hostgroup",function(t){for(var r='<option value=""><\/option>',i=0;i<t.result.length;i++)r+='<option value="'+t.result[i].groupid+'">'+t.result[i].name+"<\/option>";$(".group").html(r);n.render("select")});$(".query").delegate(".btnQuery","click",function(){$(".query").append(l);var t=$(this.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.lastChild).find(".group");$.getJSON("/api/Zabbix/hostgroup",function(i){for(var u='<option value=""><\/option>',r=0;r<i.result.length;r++)u+='<option value="'+i.result[r].groupid+'">'+i.result[r].name+"<\/option>";t.html(u);n.render("select")});$(this).parent().parent().find("div:eq(0)").removeClass("layui-hide");$(this).parent().parent().find("div:gt(0)").remove()});$(".query").delegate(".btnRemoveQuery","click",function(){var n=$(".btnRemoveQuery").index(this);$(this.parentNode.parentNode.parentNode.parentNode.parentNode).remove();t=s(t,n);i=s(i,n);h(i,t)});n.on("select",function(r){var o=$(r.elem),s=o.parent().parent().parent().parent().parent(),c=o.hasClass("group"),l=o.hasClass("host"),a=o.hasClass("application"),v=o.hasClass("item");c&&$.getJSON("/api/Zabbix/host?groupids="+r.value,function(t){for(var r='<option value=""><\/option>',i=0;i<t.result.length;i++)r+='<option value="'+t.result[i].hostid+'">'+t.result[i].name+"<\/option>";s.find(".host").html(r);n.render("select")});l&&(u+=$(this).text(),$.getJSON("/api/Zabbix/application?hostids="+r.value,function(t){for(var r='<option value=""><\/option>',i=0;i<t.result.length;i++)r+='<option value="'+t.result[i].applicationid+'">'+t.result[i].name+"<\/option>";s.find(".application").html(r);n.render("select")}));a&&$.getJSON("/api/Zabbix/item?applicationids="+r.value,function(t){for(var r,o,f,u,e='<option value=""><\/option>',i=0;i<t.result.length;i++){if(r=t.result[i].name,r.indexOf("$")>=0)for(o=t.result[i].key_,f=o.match(/\[(.+?)\]/g)[0].replace("[","").replace("]","").split(","),u=0;u<f.length;u++)r=r.replace("$"+(u+1),f[u]);e+='<option value="'+t.result[i].itemid+'">'+r+"<\/option>"}s.find(".item").html(e);n.render("select")});v&&(u+="_"+$(this).text(),t.push(u),u="",i.push(r.value),f.showLoading(e),h(i,t))});n.on("submit(save)",function(){return t.length>0&&i.length>0?r.prompt({title:"请输入此图表名称",formType:0},function(n,u){r.close(u);var f={};f.itemId=i.join(",");f.timeFrom="";f.timeTill="";f.itemName=t.join(",");f.chartsName=n;$.ajax({type:"post",url:"/api/Charts/add_charts",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(f),success:function(n){n.code==0?r.msg(n.msg,{icon:1,time:1e3},function(){window.location.reload()}):r.msg(n.msg,{icon:5,time:1e3})}})}):r.msg("无监控数据，不可保存"),!1});window.addEventListener("resize",function(){f.resize()})});