layui.use(["form","layer"],function(){function h(n,t){for(var r=[],i=0;i<n.length;i++)i!=t&&r.push(n[i]);return r}function c(n,t){for(var r="/api/Zabbix/history?",i=0;i<n.length;i++)r+="&itemids="+n[i];$.getJSON(r,function(i){for(var u,f,o,e=[],s=i.result,r=0;r<n.length;r++)u=[],f=[],s.map(function(t){t.itemid==n[r]&&(f.push(t.value),u.push(v(t.clock)))}),o={name:t[r],type:"line",data:f},e.push(o);l(e,u,t)})}function l(n,t,i){f.clear();let r={tooltip:{trigger:"axis"},legend:{data:i},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",data:t},yAxis:{type:"log"},series:n};f.setOption(r);f.hideLoading()}function v(n){var s=new Date,o=new Date(n*1e3),u=o.getMonth()+1,t,i,r,f,e;return(u=u<10?"0"+u:u,t=o.getDate(),t=t<10?"0"+t:t,i=o.getHours(),i=i<10?"0"+i:i,r=o.getMinutes(),r=r<10?"0"+r:r,f=s.getMonth()+1,f=f<10?"0"+f:f,e=s.getDate(),e=e<10?""+e:e,u==f&&t==e)?i+":"+r:u+"/"+t+" "+i+":"+r}var i=layui.form,r=layui.layer,e,u;$(".layui-form-item .layui-form-label").css("width","auto");e="";u="";let t=[],n=[],o={},s="shine",f=echarts.init(document.getElementById("charts")),a=$(".query>div").prop("outerHTML");l([],[],[]);$.getJSON("/js/themes/"+s+".json",function(n){echarts.registerTheme(s,n.theme);o=n.loading});$.getJSON("/api/Zabbix/hostgroup",function(n){for(var r='<option value=""><\/option>',t=0;t<n.result.length;t++)r+='<option value="'+n.result[t].groupid+'">'+n.result[t].name+"<\/option>";$(".group").html(r);i.render("select")});$(".query").delegate(".btnQuery","click",function(){$(".query").append(a);var n=$(this.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.lastChild).find(".group");$.getJSON("/api/Zabbix/hostgroup",function(t){for(var u='<option value=""><\/option>',r=0;r<t.result.length;r++)u+='<option value="'+t.result[r].groupid+'">'+t.result[r].name+"<\/option>";n.html(u);i.render("select")});$(this).parent().parent().find("div:eq(0)").removeClass("layui-hide");$(this).parent().parent().find("div:gt(0)").remove()});$(".query").delegate(".btnRemoveQuery","click",function(){var i=$(".btnRemoveQuery").index(this);$(this.parentNode.parentNode.parentNode.parentNode.parentNode).remove();t=h(t,i);n=h(n,i);c(n,t)});i.on("select",function(r){var s=$(r.elem),h=s.parent().parent().parent().parent().parent(),y=s.hasClass("group"),p=s.hasClass("host"),w=s.hasClass("application"),b=s.hasClass("item"),l,v,a;y&&$.getJSON("/api/Zabbix/host?groupids="+r.value,function(n){for(var r='<option value=""><\/option>',t=0;t<n.result.length;t++)r+='<option value="'+n.result[t].hostid+'">'+n.result[t].name+"<\/option>";h.find(".host").html(r);i.render("select")});p&&(e=$(this).text(),$.getJSON("/api/Zabbix/application?hostids="+r.value,function(n){for(var r='<option value=""><\/option>',t=0;t<n.result.length;t++)r+='<option value="'+n.result[t].applicationid+'">'+n.result[t].name+"<\/option>";h.find(".application").html(r);i.render("select")}));w&&$.getJSON("/api/Zabbix/item?applicationids="+r.value,function(n){for(var r,o,f,u,e='<option value=""><\/option>',t=0;t<n.result.length;t++){if(r=n.result[t].name,r.indexOf("$")>=0)for(o=n.result[t].key_,f=o.match(/\[(.+?)\]/g)[0].replace("[","").replace("]","").split(","),u=0;u<f.length;u++)r=r.replace("$"+(u+1),f[u]);e+='<option value="'+n.result[t].itemid+'">'+r+"<\/option>"}h.find(".item").html(e);i.render("select")});b&&(u=e+"_"+$(this).text(),l=h.find(".itemId").val(),v=function(n){return n==l},l>0?(a=n.findIndex(v),n[a]=r.value,t[a]=u):(n.push(r.value),t.push(u)),u="",h.find(".itemId").val(r.value),f.showLoading(o),c(n,t))});i.on("submit(save)",function(){return t.length>0&&n.length>0?r.prompt({title:"请输入此图表名称",formType:0},function(i,u){r.close(u);var f={};f.itemId=n.join(",");f.timeFrom="";f.timeTill="";f.itemName=t.join(",");f.chartsName=i;$.ajax({type:"post",url:"/api/Charts/add_charts",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(f),success:function(n){n.code==0?r.msg(n.msg,{icon:1,time:1e3},function(){window.location.reload()}):r.msg(n.msg,{icon:5,time:1e3})}})}):r.msg("无监控数据，不可保存"),!1});window.addEventListener("resize",function(){f.resize()})});